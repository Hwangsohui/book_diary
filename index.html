import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } from 'firebase/firestore';

// Firebase ì„¤ì • ë° ì•± ID ê°€ì ¸ì˜¤ê¸°
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

function App() {
    // Firebase ì¸ìŠ¤í„´ìŠ¤ ë° ì‚¬ìš©ì ID ìƒíƒœ
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    // ì…ë ¥ í•„ë“œ ìƒíƒœ
    const [grade, setGrade] = useState('');
    const [studentNumber, setStudentNumber] = useState('');
    const [studentName, setStudentName] = useState('');
    const [bookTitle, setBookTitle] = useState('');
    const [author, setAuthor] = useState('');
    const [readDate, setReadDate] = useState('');

    // í•™ìƒì˜ ë…ì„œ ê¸°ë¡ ëª©ë¡ ìƒíƒœ
    const [studentRecords, setStudentRecords] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [message, setMessage] = useState('');

    // Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ì²˜ë¦¬
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const firebaseAuth = getAuth(app);

            setDb(firestore);
            setAuth(firebaseAuth);

            // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // ì‚¬ìš©ì ì •ì˜ í† í°ì´ ìˆìœ¼ë©´ ë¡œê·¸ì¸, ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸
                    if (initialAuthToken) {
                        await signInWithCustomToken(firebaseAuth, initialAuthToken);
                    } else {
                        await signInAnonymously(firebaseAuth);
                    }
                    setUserId(firebaseAuth.currentUser?.uid || crypto.randomUUID()); // ìµëª… ë¡œê·¸ì¸ í›„ì—ë„ userId ì„¤ì •
                }
                setIsAuthReady(true); // ì¸ì¦ ì¤€ë¹„ ì™„ë£Œ
                setIsLoading(false);
            });

            return () => unsubscribe(); // í´ë¦°ì—… í•¨ìˆ˜
        } catch (error) {
            console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            setMessage("ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            setIsLoading(false);
        }
    }, []);

    // í•™ìƒ ì •ë³´ ë³€ê²½ ì‹œ í•´ë‹¹ í•™ìƒì˜ ë…ì„œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    useEffect(() => {
        // í•™ë…„, ë²ˆí˜¸, ì´ë¦„ ì¤‘ í•˜ë‚˜ë¼ë„ ë¹„ì–´ìˆìœ¼ë©´ ì¡°íšŒë¥¼ í•˜ì§€ ì•Šê³  ê¸°ë¡ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        if (!db || !isAuthReady || !userId || !grade || !studentNumber || !studentName) {
            setStudentRecords([]);
            return;
        }

        setMessage('ë…ì„œ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ (ì‚¬ìš©ìë³„ ë¹„ê³µê°œ ë°ì´í„°)
        const recordsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/readingRecords`);

        // í•™ë…„, ë²ˆí˜¸, ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬
        const q = query(
            recordsCollectionRef,
            where('grade', '==', grade),
            where('studentNumber', '==', studentNumber),
            where('studentName', '==', studentName)
        );

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const records = [];
            snapshot.forEach((doc) => {
                records.push({ id: doc.id, ...doc.data() });
            });
            // ë‚ ì§œ (readDate) ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ë‚ ì§œê°€ ìœ„ë¡œ ì˜¤ë„ë¡)
            records.sort((a, b) => {
                if (a.readDate && b.readDate) {
                    return new Date(b.readDate) - new Date(a.readDate);
                }
                return 0;
            });
            setStudentRecords(records);
            setMessage('ë…ì„œ ê¸°ë¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }, (error) => {
            console.error("ë…ì„œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            setMessage("ë…ì„œ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });

        return () => unsubscribe(); // í´ë¦°ì—… í•¨ìˆ˜
    }, [db, isAuthReady, userId, grade, studentNumber, studentName]); // ì˜ì¡´ì„± ë°°ì—´

    // ë…ì„œ ê¸°ë¡ ì¶”ê°€ í•¸ë“¤ëŸ¬
    const handleAddRecord = async (e) => {
        e.preventDefault();

        if (!db || !userId) {
            setMessage("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!grade || !studentNumber || !studentName || !bookTitle || !author || !readDate) {
            setMessage("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        setMessage('ë…ì„œ ê¸°ë¡ì„ ì €ì¥ ì¤‘...');
        try {
            // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ (ì‚¬ìš©ìë³„ ë¹„ê³µê°œ ë°ì´í„°)
            const recordsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/readingRecords`);
            await addDoc(recordsCollectionRef, {
                grade,
                studentNumber,
                studentName,
                bookTitle,
                author,
                readDate,
                timestamp: serverTimestamp() // ì„œë²„ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
            });
            setMessage('ë…ì„œ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            // ì±… ì œëª©ê³¼ ì €ì í•„ë“œ ì´ˆê¸°í™”
            setBookTitle('');
            setAuthor('');
        } catch (error) {
            console.error("ë…ì„œ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            setMessage("ë…ì„œ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    };

    if (isLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <p className="text-lg font-semibold text-gray-700">ì•±ì„ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-6 lg:p-8 flex flex-col items-center">
            <script src="https://cdn.tailwindcss.com"></script>
            {/* Poor Story í°íŠ¸ ì¶”ê°€ */}
            <link href="https://fonts.googleapis.com/css2?family=Poor+Story&display=swap" rel="stylesheet" />
            <style>
                {`
                body {
                    font-family: 'Poor Story', cursive; /* Poor Story í°íŠ¸ ì ìš© */
                }
                input[type="date"]::-webkit-calendar-picker-indicator {
                    filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg) brightness(0.9);
                }
                `}
            </style>

            <div className="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl mb-8 border border-blue-200">
                <h1 className="text-3xl sm:text-4xl font-bold text-center text-blue-700 mb-6 flex items-center justify-center">
                    <span className="mr-3 text-4xl sm:text-5xl">ğŸ“–</span> ë…ì„œ í™œë™ ì¼ì§€
                </h1>
                <p className="text-center text-gray-600 mb-4">í˜„ì¬ ì‚¬ìš©ì ID: <span className="font-mono text-sm bg-gray-100 px-2 py-1 rounded-md">{userId || 'N/A'}</span></p>

                <form onSubmit={handleAddRecord} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label htmlFor="grade" className="block text-sm font-medium text-gray-700 mb-1">í•™ë…„</label>
                            <input
                                type="text"
                                id="grade"
                                value={grade}
                                onChange={(e) => setGrade(e.target.value)}
                                placeholder="ì˜ˆ: 3"
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="studentNumber" className="block text-sm font-medium text-gray-700 mb-1">ë²ˆí˜¸</label>
                            <input
                                type="text"
                                id="studentNumber"
                                value={studentNumber}
                                onChange={(e) => setStudentNumber(e.target.value)}
                                placeholder="ì˜ˆ: 15"
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="studentName" className="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                            <input
                                type="text"
                                id="studentName"
                                value={studentName}
                                onChange={(e) => setStudentName(e.target.value)}
                                placeholder="ì˜ˆ: í™ê¸¸ë™"
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required
                            />
                        </div>
                    </div>

                    <hr className="my-6 border-gray-200" />

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label htmlFor="bookTitle" className="block text-sm font-medium text-gray-700 mb-1">ì±… ì œëª©</label>
                            <input
                                type="text"
                                id="bookTitle"
                                value={bookTitle}
                                onChange={(e) => setBookTitle(e.target.value)}
                                placeholder="ì˜ˆ: ì–´ë¦° ì™•ì"
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="author" className="block text-sm font-medium text-gray-700 mb-1">ì €ì</label>
                            <input
                                type="text"
                                id="author"
                                value={author}
                                onChange={(e) => setAuthor(e.target.value)}
                                placeholder="ì˜ˆ: ì•™íˆ¬ì•ˆ ë“œ ìƒí…ì¥í˜ë¦¬"
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required
                            />
                        </div>
                    </div>

                    <div>
                        <label htmlFor="readDate" className="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input
                            type="date"
                            id="readDate"
                            value={readDate}
                            onChange={(e) => setReadDate(e.target.value)}
                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            required
                        />
                    </div>

                    <button
                        type="submit"
                        className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                    >
                        ê¸°ë¡ ì¶”ê°€
                    </button>
                </form>

                {message && (
                    <p className={`mt-4 text-center text-sm ${message.includes('ì‹¤íŒ¨') ? 'text-red-600' : 'text-green-600'}`}>
                        {message}
                    </p>
                )}
            </div>

            <div className="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl border border-blue-200">
                <h2 className="text-2xl sm:text-3xl font-bold text-center text-blue-700 mb-6 flex items-center justify-center">
                    <span className="mr-3 text-3xl sm:text-4xl">ğŸ“š</span> ë…ì„œ ê¸°ë¡ ì¡°íšŒ
                </h2>
                {studentRecords.length === 0 && (grade || studentNumber || studentName) ? (
                    <p className="text-center text-gray-500">
                        {grade && studentNumber && studentName
                            ? `${grade}í•™ë…„ ${studentNumber}ë²ˆ ${studentName} í•™ìƒì˜ ë…ì„œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!`
                            : 'ì •í™•í•œ ë…ì„œ ê¸°ë¡ ì¡°íšŒë¥¼ ìœ„í•´ í•™ë…„, ë²ˆí˜¸, ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'
                        }
                    </p>
                ) : studentRecords.length === 0 ? (
                    <p className="text-center text-gray-500">
                        ì •í™•í•œ ë…ì„œ ê¸°ë¡ ì¡°íšŒë¥¼ ìœ„í•´ í•™ë…„, ë²ˆí˜¸, ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    </p>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead className="bg-blue-50">
                                <tr>
                                    <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                                        ë‚ ì§œ
                                    </th>
                                    <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                                        ì±… ì œëª©
                                    </th>
                                    <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                                        ì €ì
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {studentRecords.map((record) => (
                                    <tr key={record.id} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-800">
                                            {record.readDate}
                                        </td>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-blue-600">
                                            {record.bookTitle}
                                        </td>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                            {record.author}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );
}

export default App;
